<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Kerwin"><meta name="copyright" content="Kerwin"><title>游于北方知寒</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Kerwin</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">5</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">4</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">2</span></a></div></div></div><nav id="nav" style="background-image: url(/img/bgimg4.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">游于北方知寒</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">游于北方知寒</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/13/linux-pm2-deploy/">pm2部署应用到服务器</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-13</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Linux/">Linux</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a></span><div class="content"><h2 id="使用-pm2-deploy-实现应用的自动部署"><a href="#使用-pm2-deploy-实现应用的自动部署" class="headerlink" title="使用 pm2 deploy 实现应用的自动部署"></a>使用 pm2 deploy 实现应用的自动部署</h2><p><strong>当所有配置完成之后，使用 pm2 部署应用只需三步</strong></p>
<ol>
<li>git push 将开发的代码推送到 github</li>
<li>pm2 deploy ecosystem.config.js production setup // 首次向服务器部署执行，从 github 上拉取代码到服务器</li>
<li>pm2 deploy ecosystem.config.js production // 部署，运行，看到 success</li>
</ol>
<h3 id="配置-ssh-免密认证"><a href="#配置-ssh-免密认证" class="headerlink" title="配置 ssh 免密认证"></a>配置 ssh 免密认证</h3><p>首先先行实现本地与服务器的免密登录，方法参考</p>
<p>之后实现本地和服务器与 github 的免密认证，本地和服务器操作一样，服务器端建议在非 root 用户下操作</p>
<ol>
<li><p>输入 <code>ls -al ~/.ssh</code> 以查看是否存在现有 SSH 密钥：<br><code>$ ls -al ~/.ssh # 列出 .ssh 目录中的文件（如果有）</code></p>
</li>
<li><p>如果没有，先生成公钥<br><code>$ ssh-keygen -t rsa -b 4096 -C &quot;Your Email&quot;</code></p>
</li>
<li><p>将 SSH key 加入代理<br><code>$ eval $(ssh-agent -s) // 启动 ssh-agent</code><br><code>$ ssh-add ~/.ssh/id_rsa // 将私钥加入代理中</code></p>
</li>
</ol>
<p>将本地与服务器的 rsa 公钥添加到 github，建议将本地的公钥添加到账户 Settings 里面的 SSH and GPG keys</p>
<p><img src="/images/pm2-3.jpg" alt=""></p>
<p>将服务器的 rsa 公钥添加到项目下 Settings 里面的 Deploy keys，这样服务器只能从 github 拉取代码，而不能提交，禁止从服务器端修改代码</p>
<p><img src="/images/pm2-1.jpg" alt=""><br><img src="/images/pm2-2.jpg" alt=""></p>
<p>分别在本地和服务端输入指令 <code>ssh -T git@github.com</code> 验证是否与 github 打通。</p>
<p>至此，三方的免密认证完成。</p>
<h3 id="pm2-配置"><a href="#pm2-配置" class="headerlink" title="pm2 配置"></a>pm2 配置</h3><p>关于 pm2 的介绍和常用指令，查看<a href="https://segmentfault.com/a/1190000018439311" target="_blank" rel="noopener">这里</a></p>
<ol>
<li>先在本地和服务端安装 pm2，确认安装成功</li>
<li>在本地和 github 生成一个新项目，做好本地与映射</li>
<li>在本地项目的根目录下运行 <code>pm2 ecosystem</code>，生成 ecosystem.config.js 配置文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  apps: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: &#39;kerwin-koa&#39;,      &#x2F;&#x2F;应用名</span><br><span class="line">      script: &#39;app.js&#39;,   &#x2F;&#x2F;应用文件位置</span><br><span class="line">      env: &#123;</span><br><span class="line">        COMMON_VARIABLE: &#39;true&#39;</span><br><span class="line">      &#125;,</span><br><span class="line">      env_production : &#123;</span><br><span class="line">        NODE_ENV: &#39;production&#39;  &#x2F;&#x2F;使用production模式 pm2 start ecosystem.config.js --env production</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  deploy: &#123;</span><br><span class="line">      production : &#123;</span><br><span class="line">        user: &#39;kerwin&#39;,                      &#x2F;&#x2F;ssh 用户</span><br><span class="line">        host: &#39;49.235.242.185&#39;,              &#x2F;&#x2F;ssh 地址</span><br><span class="line">        ref: &#39;origin&#x2F;master&#39;,             &#x2F;&#x2F;GIT远程&#x2F;分支</span><br><span class="line">        repo: &#39;git@github.com:repo.git&#39;,   &#x2F;&#x2F;git地址</span><br><span class="line">        path: &#39;&#x2F;var&#x2F;www&#x2F;website&#39;,       &#x2F;&#x2F;服务器文件路径</span><br><span class="line">        &quot;post-deploy&quot;: &#39;npm install &amp;&amp; pm2 reload ecosystem.config.js --env production&#39;  &#x2F;&#x2F;部署后的动作</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a>服务器配置</h3><p>非 root 用户创建文件目录，执行</p>
<p><code>sudo mkdir /var/www/</code><br><code>sudo mkdir /var/www/website/</code></p>
<p>然后修改文件权限，否则权限不够，无法部署</p>
<p><code>chmod 777 /var/www/website/</code></p>
<h3 id="本地项目下运行"><a href="#本地项目下运行" class="headerlink" title="本地项目下运行"></a>本地项目下运行</h3><p>首次向服务器部署执行</p>
<p><code>pm2 deploy ecosystem.config.js production setup</code></p>
<p>之后执行</p>
<p><code>pm2 deploy ecosystem.config.js production</code></p>
<p>看到 success，成功</p>
<h3 id="服务器查看运行"><a href="#服务器查看运行" class="headerlink" title="服务器查看运行"></a>服务器查看运行</h3><p>服务器运行<code>pm2 list</code>，查看进程是否启动</p>
<p><img src="/images/pm2-4.jpg" alt=""></p>
<p>我刚开始运行，status 那里是 errored 状态，如果你也遇到这种状况，可以运行 <code>pm2 show 0</code> 查看出错信息</p>
<p><img src="/images/pm2-5.jpg" alt=""></p>
<p>我之后有在服务器运行了<code>node /var/www/website/source/app.js</code>，提示我端口被占用，我改了一下端口，再执行 <code>pm2 deploy ecosystem.config.js production</code>，解决！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/11/deploy-git-server/">搭建Git服务器</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-11</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Linux/">Linux</a></span><div class="content"><h4 id="服务器安装-git"><a href="#服务器安装-git" class="headerlink" title="服务器安装 git"></a>服务器安装 git</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 查看用户信息</span><br><span class="line">[root@VM_0_14_centos ~]# uname -a</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 安装</span><br><span class="line">[root@VM_0_14_centos ~]# yum -y install git</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 查看是否安装成功</span><br><span class="line">[root@VM_0_14_centos ~]# git --version</span><br><span class="line">git version 1.8.3.1</span><br></pre></td></tr></table></figure>

<h4 id="创建-git-用户和密码"><a href="#创建-git-用户和密码" class="headerlink" title="创建 git 用户和密码"></a>创建 git 用户和密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 新建用户</span><br><span class="line">[root@VM_0_14_centos ~]# useradd git</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 设置用户密码</span><br><span class="line">[root@VM_0_14_centos ~]# passwd git</span><br><span class="line">New password:</span><br><span class="line">BAD PASSWORD: The password is shorter than 8 characters</span><br><span class="line">Retype new password:</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br></pre></td></tr></table></figure>

<h4 id="git-ssh-配置"><a href="#git-ssh-配置" class="headerlink" title="git ssh 配置"></a>git ssh 配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 切换到git用户</span><br><span class="line">[root@VM_0_14_centos ~]# su git</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 在git用户下新建 .ssh 文件夹</span><br><span class="line">[git@VM_0_14_centos ~]# mkdir .ssh</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建 authorized_keys 文件，这是公钥存放的位置，将客户端 id_rsa.pub 文件里的密钥添加进此文件</span><br><span class="line">[git@VM_0_14_centos ~]# touch .ssh&#x2F;authorized_keys</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 设置文件权限</span><br><span class="line">[git@VM_0_14_centos ~]# chmod 755 .ssh&#x2F;</span><br><span class="line">[git@VM_0_14_centos ~]# chmod 644 .ssh&#x2F;authorized_keys</span><br></pre></td></tr></table></figure>

<h4 id="初始化-git-仓库"><a href="#初始化-git-仓库" class="headerlink" title="初始化 git 仓库"></a>初始化 git 仓库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 先新建一个文件夹作为 git 仓库，假设是&#x2F;home&#x2F;gitstore</span><br><span class="line">[git@VM_0_14_centos ~]# mkdir &#x2F;home&#x2F;gitstore&#x2F;</span><br><span class="line">[git@VM_0_14_centos ~]# cd &#x2F;home&#x2F;gitstore&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建一个 git 裸仓库</span><br><span class="line">[git@VM_0_14_centos gitstore]# git init --bare hellogit.git</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 裸仓库没有工作区，因为服务器上的Git仓库纯粹是为了共享，所以不让用户直接登录到服务器上去改工作区，并且服务器上的Git仓库通常都以.git结尾。然后，把owner改为git:</span><br><span class="line">[git@VM_0_14_centos ~]# chown -R git:git hellogit.git</span><br></pre></td></tr></table></figure>

<h4 id="禁用-shell-登录"><a href="#禁用-shell-登录" class="headerlink" title="禁用 shell 登录"></a>禁用 shell 登录</h4><p>出于安全考虑，第二步创建的 git 用户不允许登录 shell，这可以通过编辑/etc/passwd 文件完成。</p>
<p>切回到 root 用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[git@VM_0_14_centos gitstore]# exit</span><br><span class="line"></span><br><span class="line">[root@VM_0_14_centos gitstore]# vim &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<p>找到类似下面的一行：</p>
<p><code>git:x:1001:1001:,,,:/home/git:/bin/bash</code></p>
<p>改为：</p>
<p><code>git:x:1001:1001:,,,:/home/git:/usr/bin/git-shell</code></p>
<h4 id="克隆远程仓库"><a href="#克隆远程仓库" class="headerlink" title="克隆远程仓库"></a>克隆远程仓库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git clone git@server:&#x2F;home&#x2F;gitstore&#x2F;hellogit.git</span><br><span class="line">Cloning into &#39;sample&#39;...</span><br><span class="line">warning: You appear to have cloned an empty repository.</span><br></pre></td></tr></table></figure>

<p><strong>参考链接</strong><br><a href="https://www.liaoxuefeng.com/wiki/896043488029600/899998870925664" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/896043488029600/899998870925664</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/11/deploy-linux-ssh/">SSH免密登录踩坑(Permission denied (publickey,gssapi-keyex,gssapi-with-mic).)</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-11</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Linux/">Linux</a></span><div class="content"><p>最近尝试使用 scp 上传本事文件到服务器，提示错误：<br><code>Permission denied (publickey,gssapi-keyex,gssapi-with-mic).</code><br>查了很多资料，得知大概是配置 ssh 登录身份验证时碰到问题，先 mark 一下 ssh 免密码登录 root 用户.<br><strong>解决办法：</strong></p>
<p>假设：现有 2 台机器<br>1、个人机 A<br>2、服务器 B</p>
<p>现在 A 主机要通过 ssh 连接到 B 主机，需要在 A 主机上生成一个 ssh 公钥，然后写入到 B 主机的 authorized_keys 文件即可。</p>
<ol>
<li>在 A 主机下生成公钥:<br><code>ssh-keygen -t rsa</code></li>
<li>将生成的公钥写入 A 主机的 authorized_keys 文件<br><code>cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</code></li>
<li>将 A 主机下的 authorized_keys 发送到 B 主机的 root 账户的 <code>~/.ssh/</code> 目录下<br>如果此时还没有设置过 root 账户初始密码，需要先设置一下<ul>
<li>(1)在 B 主机 输入 <code>sudo passwd</code> ,之后输入要设置的密码</li>
<li>(2)之后 A 主机还是不能通过 ssh 输入密码的方式连接到 B 主机的 root 账户，因为 ssh 默认不能连接到 root 账户，需要更改一下 B 主机 ssh 的配置，修改 /etc/ssh/sshd_config 文件<br><code>vim /etc/ssh/sshd_config</code><br>找到 <code>PermitRootLogin prohibit-password</code>，其修改为 yes，即 <code>PermitRootLogin yes</code><br>然后执行 <code>service sshd restart</code> 重启 ssh 服务</li>
<li>(3)将 A 主机中的公钥，发送到 B 主机，先在 B 主机的 root 账户下执行<br><code>ssh-keygen -t rsa</code>，创建一个 .ssh 目录<br>如果有已经有 ssh 目录，则直接下面的操作<br>之后在 A 主机的 root 账户下执行<br><code>scp ~/.ssh/authorized_keys root@B主机域名:/~/.ssh/</code><br>之后修改 B 主机接受到的 authorized_keys 的权限，在 B 主机中执行<br><code>chmod 600 ~/.ssh/authorized_keys</code></li>
</ul>
</li>
</ol>
<p><strong>踩坑</strong></p>
<h4 id="1-etc-ssh-sshd-config-配置问题"><a href="#1-etc-ssh-sshd-config-配置问题" class="headerlink" title="1. /etc/ssh/sshd_config 配置问题"></a>1. /etc/ssh/sshd_config 配置问题</h4><p>在查找相关资料的过程中，看了一些如何配置启用密钥对进行 SSH 登录的方法，很多说修改 <code>/etc/ssh/sshd_config</code> 文件，找到其中这几行配置注释，并指定需要的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 允许 root 认证登录</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">&#x2F;&#x2F; 允许密钥认证</span><br><span class="line">RSAAuthentication yes</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line">&#x2F;&#x2F; 默认公钥存放的位置</span><br><span class="line">AuthorizedKeysFile .ssh&#x2F;authorized_keys</span><br></pre></td></tr></table></figure>

<p>配置文件里没有找到 RSAAuthentication 这行注释或者配置项，因为 CentOS7.4 弃用 RSAAuthentication 支持。</p>
<h4 id="2-ssh-的配置目录权限问题"><a href="#2-ssh-的配置目录权限问题" class="headerlink" title="2. ssh 的配置目录权限问题"></a>2. ssh 的配置目录权限问题</h4><p>由于 ssh 的权限直接关系到服务器的安全问题，因此 ssh 每次读取配置都会校验相关文件夹和文件的权限，以防止权限过大对外暴露。</p>
<p>表现：<br>设置了.ssh 目录，在 authorized_keys 设置了 key 后登录还提示需要输入密码。</p>
<p>解决方法：<br>注意权限，.ssh 权限 700，authorized_keys 权限 600，就 KO 啦！</p>
<p>chmod 700 ~/.ssh/<br>chmod 600 ~/.ssh/authorized_keys</p>
<p><strong>参考文章</strong><br><a href="https://blog.csdn.net/yanhe156/article/details/79653331" target="_blank" rel="noopener">https://blog.csdn.net/yanhe156/article/details/79653331</a><br><a href="https://my.oschina.net/leejun2005/blog/285795" target="_blank" rel="noopener">https://my.oschina.net/leejun2005/blog/285795</a><br><a href="https://www.cnblogs.com/Leroscox/p/9627809.html" target="_blank" rel="noopener">https://www.cnblogs.com/Leroscox/p/9627809.html</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/07/first-article/">闻王昌龄左迁龙标遥有此寄</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-07</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/%E5%93%94%E5%93%94%E8%B5%96%E8%B5%96/">哔哔赖赖</a></span><div class="content"><p>杨花落尽子规啼，闻到龙标过五溪。<br>我寄愁心与明月，随风直到夜郎西。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/01/webpack-postcss/">使用 webpack postcss-loader</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-01</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/Webpack/">Webpack</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/webpack/">webpack</a></span><div class="content"><h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D postcss-loader</span><br></pre></td></tr></table></figure>

<p>###webpack.config.js (recommended)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">module.exports &#x3D; &#123;</span><br><span class="line">  module: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: &#x2F;\.css$&#x2F;,</span><br><span class="line">        use: [</span><br><span class="line">          &#39;style-loader&#39;,</span><br><span class="line">          &#123; loader: &#39;css-loader&#39;, options: &#123; importLoaders: 1 &#125; &#125;,</span><br><span class="line">          &#39;postcss-loader&#39;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>###loader 应用顺序</p>
<p><em>一个匹配规则中可以配置使用多个 loader，即一个模块文件可以经过多个 loader 的转换处理，执行顺序是从最后配置的 loader 开始，一步步往前。例如，一个 css 文件会途径 postcss-loader、css-loader、style-loader 处理，成为一个可以打包的模块。</em></p>
<p><strong>loader 的应用顺序在配置多个 loader 一起工作时很重要。</strong><br>###postcss 插件 #####安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install postcss-import  cssnano --save-dev</span><br></pre></td></tr></table></figure>

<p>####postcss-import<br>使用 postcss-import 插件，遵循<code>@import</code>规则，你可以将<code>reset.css</code>样式合并到你的主样式表中，减少<code>http</code>请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@import &#39;reset.css&#39;;</span><br></pre></td></tr></table></figure>

<p>####cssnext<br>Use tomorrow’s CSS ,today!<br>可以在样式表中利用  <a href="http://cssnext.io/" target="_blank" rel="noopener">cssnext</a>  额外增加的一些 css 规范。cssnext 是一个 PostCSS 的包，其中包含了大量的特性组件，比如  <a href="http://www.w3.org/TR/css-variables/" target="_blank" rel="noopener">custom properties</a>  和  <a href="http://dev.w3.org/csswg/css-extensions/#custom-selectors" target="_blank" rel="noopener">custom selectors</a>。<br>cssnext 中已经包含了对 Autoprefixer 的使用，因此使用了 cssnext 就不再需要使用 Autoprefixer。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* custom properties *&#x2F;</span><br><span class="line">:root &#123;</span><br><span class="line">  --heading-color: #ff0000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;* custom selectors *&#x2F;</span><br><span class="line">@custom-selector :--headings h1, h2, h3, h4, h5, h6;</span><br><span class="line"></span><br><span class="line">&#x2F;* usage *&#x2F;</span><br><span class="line">:--headings &#123;</span><br><span class="line">  color: var(--heading-color);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>####css-mqpacker<br><a href="https://github.com/hail2u/node-css-mqpacker" target="_blank" rel="noopener">css-mqpacker</a>插件可以找到样式表中相同的媒体查询样式合并到一个媒体查询中。这样允许你在写 CSS 的时候，媒体查询可以重复编写，你也不用担心这样会对你的样式产生冗余代码，而影响你的效率。</p>
<p>####cssnano<br>非常强大的 CSS 优化的插件包</p>
<p>cssnano 优化包括下面一些类型：</p>
<p>删除空格和最后一个分号<br>删除注释<br>优化字体权重<br>丢弃重复的样式规则<br>优化 calc()<br>压缩选择器<br>减少手写属性<br>合并规则</p>
<p>###webpack 配置<br>####webpack.config.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: &#x2F;\.css$&#x2F;,</span><br><span class="line">  use: ExtractTextPlugin.extract(&#123;</span><br><span class="line">    use: [&#123;</span><br><span class="line">      loader: &quot;css-loader&quot;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      loader: &#39;postcss-loader&#39;,</span><br><span class="line">      options:&#123;</span><br><span class="line">        &#x2F;&#x2F; ident: &#39;postcss&#39;,</span><br><span class="line">        plugins: (loader) &#x3D;&gt;  [</span><br><span class="line">          require(&#39;postcss-import&#39;)(&#123; root: loader.resourcePath &#125;),</span><br><span class="line">          require(&#39;postcss-cssnext&#39;)(),</span><br><span class="line">          require(&#39;autoprefixer&#39;)(),</span><br><span class="line">          &#x2F;&#x2F;require(&#39;cssnano&#39;)()</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;],</span><br><span class="line">    &#x2F;&#x2F; 在开发环境使用 style-loader</span><br><span class="line">    fallback: &quot;style-loader&quot;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span></div></nav></div></div><footer class="footer-bg" style="background-image: url(/img/bgimg4.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Kerwin</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>